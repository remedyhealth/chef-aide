#!/bin/bash

AIDE_LOG="/var/log/aide/aide.log"
OUTFILE=`mktemp`

RECORD=no
IGNORE_NEXT=no

while IFS='' read -r line || [[ -n "$line" ]]; do
  echo $line | egrep -o "^(\w+) entries:$" > /dev/null
  if [ $? -eq 0 ]; then
    RECORD=yes
    IGNORE_DASH=yes
    IGNORE_WHITESPACE=yes
    echo "$line" >> $OUTFILE
  else
    if [ "${RECORD}" == "yes" ]; then
      if [[ $line == *-* ]] && [ "${IGNORE_DASH}" == "yes" ]; then
        IGNORE_DASH=no
      elif [ "$line" == "" ] && [ "${IGNORE_WHITESPACE}" == "yes" ] ; then
        IGNORE_WHITESPACE=no
      elif [ "$line" == "" ] || [[ $line == *-* ]]; then
        RECORD=no
        echo "" >> $OUTFILE
      else
        echo $line >> $OUTFILE
      fi
    fi
  fi
done < "$AIDE_LOG"

OUTPUT=$(sed '$ d' $OUTFILE)

curl -s -X POST -H 'Content-type: application/json' --data "{'text': '*`hostname -f`* reported the following modifications:\n\`\`\`$OUTPUT\`\`\`'}" <%= @slack_webhook_url %> > /dev/null

rm $OUTFILE

exit 0
